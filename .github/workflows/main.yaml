deployments-tests:
  needs: complete-demo-sync-check
  runs-on: ubuntu-latest
  env:
    kind-version: 'v0.10.0'
    kind-image: 'kindest/node:v1.20.0'
  timeout-minutes: 15  # extra buffer
  steps:
    - uses: actions/checkout@v2

    - name: Start KinD
      uses: engineerd/setup-kind@v0.5.0
      with:
        version: ${{ env.kind-version }}
        image: ${{ env.kind-image }}

    - name: Wait cluster to start
      run: |
        echo "Waiting for Kubernetes cluster to be ready..."
        until kubectl version --short; do
          echo "Cluster not ready yet..."
          sleep 5
        done

    - name: Deploy Complete Demo
      run: |
        echo "Applying complete-demo.yaml"
        kubectl apply -f deploy/kubernetes/complete-demo.yaml

        MAX_WAIT=600  # seconds (10 minutes)
        SLEEP=5
        ELAPSED=0

        echo "Waiting for pods to be ready..."
        while [ "$(kubectl get pods -A --no-headers | grep -cEv '([0-9]+)/\1')" -ne 0 ]; do
          sleep $SLEEP
          ELAPSED=$((ELAPSED + SLEEP))
          if [ $ELAPSED -ge $MAX_WAIT ]; then
            echo "Timeout waiting for pods!"
            echo "Status of all pods:"
            kubectl get pods -A
            echo "Detailed pod descriptions:"
            kubectl describe pods -A
            echo "Logs of all pods in sock-shop namespace:"
            for pod in $(kubectl get pods -n sock-shop -o name); do
              echo "Logs for $pod:"
              kubectl logs -n sock-shop $pod || true
            done
            exit 1
          fi
        done

        echo "All pods are ready!"
        kubectl get pods -A